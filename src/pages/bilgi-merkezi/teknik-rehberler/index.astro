---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumb from '../../../components/ui/Breadcrumb.astro';
import SupportCTA from '../../../components/ui/SupportCTA.astro';
import { getCollection } from 'astro:content';
import { BookOpen, Clock, ArrowRight, Search, X } from 'lucide-react';

const breadcrumbItems = [
  { label: 'Bilgi Merkezi', href: '/bilgi-merkezi' },
  { label: 'Teknik Rehberler' }
];

const guides = await getCollection('guides');
const trGuides = guides.filter(guide => guide.data.lang === 'tr');

const sortedGuides = trGuides.sort((a, b) =>
  new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

const difficulties = ['Başlangıç', 'Orta', 'İleri'];
const difficultyStyles = {
  'Başlangıç': { bg: 'bg-green-100', text: 'text-green-700' },
  'Orta': { bg: 'bg-yellow-100', text: 'text-yellow-700' },
  'İleri': { bg: 'bg-red-100', text: 'text-red-700' }
};

const categories = Array.from(
  new Set(
    sortedGuides
      .map((guide) => guide.data.category)
      .filter((cat): cat is string => Boolean(cat)),
  ),
).sort();
---

<BaseLayout
  title="Teknik Rehberler - GenPowerLab"
  description="Jeneratörler hakkında kapsamlı teknik rehberler ve yazılar."
>
  <div class="container mx-auto px-4 lg:px-1 py-6">
    <Breadcrumb items={breadcrumbItems} />

    <!-- Page Hero -->
  <section class="bg-white rounded-2xl  mb-6 ">
      <div class="flex flex-col lg:flex-row lg:items-center gap-4">
        <!-- Search Input -->
        <div class="relative flex-1 mt-6">
          <div class="absolute inset-y-0 left-0 flex items-center pl-2 text-gray-400 peer-focus-within:text-blue-500 transition-colors">
            <Search className="w-4 h-4" />
          </div>
          <input
            type="text"
            id="guide-search"
            placeholder="Rehber ara..."
            class="w-full pl-8 pr-12 py-3 border-none focus:ring-0 focus:outline-none outline-none text-sm bg-transparent peer"
          />
          <button
            type="button"
            id="guide-clear"
            class="input-clear hidden"
            aria-label="Aramayı temizle"
          >
            <X className="w-4 h-4" />
          </button>
          <!-- Border div that gets focus styles -->
          <div class="absolute inset-0 border border-gray-200 rounded-xl peer-focus-within:border-blue-500 peer-focus-within:ring-2 peer-focus-within:ring-blue-100 pointer-events-none transition-all"></div>
        </div>

        <!-- Filters -->
        <div class="flex flex-col md:flex-row gap-3 lg:w-auto">
          <div class="filter-select flex-1 md:flex-initial">
            <label for="difficulty-select">Seviye</label>
            <select id="difficulty-select">
              <option value="all">Tümü</option>
              {difficulties.map((diff) => (
                <option value={diff}>{diff}</option>
              ))}
            </select>
          </div>
          <div class="filter-select flex-1 md:flex-initial">
            <label for="category-select">Kategori</label>
            <select id="category-select">
              <option value="all">Tümü</option>
              {categories.map((cat) => (
                <option value={cat}>{cat}</option>
              ))}
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Results Info -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6 text-sm text-gray-600">
      <span class="text-gray-500">Filtrelenen sonuç: <strong id="results-count" class="text-gray-900 text-base">{sortedGuides.length}</strong></span>
      <div class="flex items-center gap-2 text-xs text-gray-500">
        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-gray-100 text-gray-700">
          <Clock className="w-3.5 h-3.5" />
          Ortalama {Math.round(sortedGuides.reduce((acc, item) => acc + parseInt(item.data.readTime || '5'), 0) / (sortedGuides.length || 1)) || 0} dk
        </span>
        <span class="hidden sm:inline">•</span>
        <span>Son güncelleme: {sortedGuides[0] ? new Date(sortedGuides[0].data.pubDate).toLocaleDateString('tr-TR') : '-'}</span>
      </div>
    </div>

    <!-- Guides List -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4" id="guides-list">
      {sortedGuides.length > 0 ? (
        sortedGuides.map((guide) => {
          const slug = guide.id.replace(/\.(md|mdx)$/, '');
          const diffStyle = guide.data.difficulty
            ? difficultyStyles[guide.data.difficulty as keyof typeof difficultyStyles]
            : null;

          return (
            <article
              class="guide-card bg-white border border-gray-200 rounded-2xl p-5 shadow-sm hover:shadow-md hover:border-blue-200 transition-all flex flex-col gap-3"
              data-difficulty={guide.data.difficulty || ''}
              data-category={guide.data.category || ''}
              data-title={guide.data.title.toLowerCase()}
            >
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-2 flex-wrap">
                  {diffStyle && (
                    <span class={`inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full ${diffStyle.bg} ${diffStyle.text}`}>
                      {guide.data.difficulty}
                    </span>
                  )}
                  {guide.data.category && (
                    <span class="text-xs font-medium text-blue-700 bg-blue-50 px-2.5 py-1 rounded-full">
                      {guide.data.category}
                    </span>
                  )}
                </div>
                <span class="text-xs text-gray-400 flex items-center gap-1">
                  <Clock className="w-3.5 h-3.5" />
                  {guide.data.readTime || '5 dk'}
                </span>
              </div>

              <div>
                <h2 class="text-xl font-semibold text-gray-900 leading-snug mb-2">
                  <a href={`/bilgi-merkezi/teknik-rehberler/${slug}`} class="hover:text-blue-600 transition-colors">
                    {guide.data.title}
                  </a>
                </h2>
                <p class="text-sm text-gray-600 leading-relaxed line-clamp-3">
                  {guide.data.description}
                </p>
              </div>

              <div class="flex items-center justify-between pt-2">
                <div class="text-xs text-gray-400">
                  Yayın: {new Date(guide.data.pubDate).toLocaleDateString('tr-TR')}
                </div>
                <a
                  href={`/bilgi-merkezi/teknik-rehberler/${slug}`}
                  class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 hover:text-blue-700 transition-colors"
                >
                  Oku
                  <ArrowRight className="w-4 h-4" />
                </a>
              </div>
            </article>
          );
        })
      ) : (
        <div class="text-center py-12 bg-white rounded-xl border border-gray-200">
          <BookOpen className="w-12 h-12 text-gray-300 mx-auto mb-3" />
          <p class="text-gray-600">Henüz rehber eklenmemiş.</p>
        </div>
      )}
    </div>

    <!-- No Results -->
    <div id="no-results" class="hidden text-center py-16 px-6 bg-white rounded-2xl border border-gray-200 mt-6">
      <Search className="w-10 h-10 text-gray-300 mx-auto mb-3" />
      <p class="text-gray-600 mb-2">Aradığınız kriterlere uygun sonuç bulunamadı.</p>
      <p class="text-sm text-gray-500">Filtreleri temizleyerek yeniden deneyebilirsiniz.</p>
    </div>

   
  </div>
  <SupportCTA />
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('guide-search') as HTMLInputElement;
    const difficultySelect = document.getElementById('difficulty-select') as HTMLSelectElement;
    const categorySelect = document.getElementById('category-select') as HTMLSelectElement;
    const guideCards = document.querySelectorAll('.guide-card');
    const noResults = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');
    const clearButton = document.getElementById('guide-clear');

    let currentDifficulty = 'all';
    let currentCategory = 'all';
    let searchTerm = '';

    function filterGuides() {
      let visibleCount = 0;

      guideCards.forEach(card => {
        const difficulty = card.getAttribute('data-difficulty') || '';
        const category = card.getAttribute('data-category') || '';
        const title = card.getAttribute('data-title') || '';

        const matchesDifficulty = currentDifficulty === 'all' || difficulty === currentDifficulty;
        const matchesCategory = currentCategory === 'all' || category === currentCategory;
        const matchesSearch = searchTerm === '' || title.includes(searchTerm.toLowerCase());

        if (matchesDifficulty && matchesCategory && matchesSearch) {
          (card as HTMLElement).style.display = 'flex';
          visibleCount++;
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      if (resultsCount) resultsCount.textContent = visibleCount.toString();
      if (noResults) noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function updateClearButton() {
      if (clearButton) {
        clearButton.classList.toggle('hidden', searchTerm.length === 0);
      }
    }

    searchInput?.addEventListener('input', (e) => {
      searchTerm = (e.target as HTMLInputElement).value;
      updateClearButton();
      filterGuides();
    });

    difficultySelect?.addEventListener('change', (e) => {
      currentDifficulty = (e.target as HTMLSelectElement).value || 'all';
      filterGuides();
    });

    categorySelect?.addEventListener('change', (e) => {
      currentCategory = (e.target as HTMLSelectElement).value || 'all';
      filterGuides();
    });

    clearButton?.addEventListener('click', () => {
      searchInput.value = '';
      searchTerm = '';
      updateClearButton();
      filterGuides();
      searchInput.focus();
    });

    updateClearButton();
  });
</script>

<style>
   .filter-select {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 160px;
  }

  .filter-select label {
    font-size: 0.78rem;
    font-weight: 600;
    color: #475569;
  }

  .filter-select select {
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 0.65rem 0.8rem;
    font-size: 0.9rem;
    color: #0f172a;
    background-color: white;
    outline: none;
    transition: border 0.2s ease, box-shadow 0.2s ease;
    min-width: 100%;
  }

  .filter-select select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
  }

  .input-clear {
    position: absolute;
    top: 50%;
    right: 0.75rem;
    transform: translateY(-50%);
    border: none;
    background: #f1f5f9;
    color: #475569;
    border-radius: 9999px;
    width: 1.75rem;
    height: 1.75rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease;
    z-index: 10;
  }

  .input-clear:hover {
    background: #e2e8f0;
    color: #1f2937;
  }
  

  /* Responsive adjustments */
  @media (max-width: 1024px) {
    .filter-select {
      min-width: 140px;
    }
  }

  @media (max-width: 768px) {
    .filter-select {
      min-width: 100%;
    }
  }
</style>
